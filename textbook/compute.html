<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>计算的本质 | TimeLine</title>
    <meta name="description" content="记录我的前端学习点滴">
    <meta name="generator" content="VuePress 1.3.0">
    
    
    <link rel="preload" href="/mblog/assets/css/0.styles.c6272ac7.css" as="style"><link rel="preload" href="/mblog/assets/js/app.b34711a8.js" as="script"><link rel="preload" href="/mblog/assets/js/2.1254f33f.js" as="script"><link rel="preload" href="/mblog/assets/js/27.7fa9686b.js" as="script"><link rel="prefetch" href="/mblog/assets/js/10.5d5957c8.js"><link rel="prefetch" href="/mblog/assets/js/11.4194f877.js"><link rel="prefetch" href="/mblog/assets/js/12.f3819994.js"><link rel="prefetch" href="/mblog/assets/js/13.3b3fceb3.js"><link rel="prefetch" href="/mblog/assets/js/14.1f383059.js"><link rel="prefetch" href="/mblog/assets/js/15.4d559c4b.js"><link rel="prefetch" href="/mblog/assets/js/16.e45fcdbd.js"><link rel="prefetch" href="/mblog/assets/js/17.c8e38934.js"><link rel="prefetch" href="/mblog/assets/js/18.fe8b93a5.js"><link rel="prefetch" href="/mblog/assets/js/19.0971f681.js"><link rel="prefetch" href="/mblog/assets/js/20.90de0776.js"><link rel="prefetch" href="/mblog/assets/js/21.4d432eb3.js"><link rel="prefetch" href="/mblog/assets/js/22.f1a67874.js"><link rel="prefetch" href="/mblog/assets/js/23.d8ef03c4.js"><link rel="prefetch" href="/mblog/assets/js/24.407ee46f.js"><link rel="prefetch" href="/mblog/assets/js/25.1febc119.js"><link rel="prefetch" href="/mblog/assets/js/26.c5c74c02.js"><link rel="prefetch" href="/mblog/assets/js/28.e3ea476f.js"><link rel="prefetch" href="/mblog/assets/js/29.ce04160a.js"><link rel="prefetch" href="/mblog/assets/js/3.14617ffe.js"><link rel="prefetch" href="/mblog/assets/js/30.b61f8116.js"><link rel="prefetch" href="/mblog/assets/js/31.87e03a7c.js"><link rel="prefetch" href="/mblog/assets/js/4.4f648c2b.js"><link rel="prefetch" href="/mblog/assets/js/5.3126dc46.js"><link rel="prefetch" href="/mblog/assets/js/6.f7b5ac92.js"><link rel="prefetch" href="/mblog/assets/js/7.2299856a.js"><link rel="prefetch" href="/mblog/assets/js/8.3b6fc075.js"><link rel="prefetch" href="/mblog/assets/js/9.cc8a5821.js">
    <link rel="stylesheet" href="/mblog/assets/css/0.styles.c6272ac7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mblog/" class="home-link router-link-active"><!----> <span class="site-name">TimeLine</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><span class="title">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Basic
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mblog/html/semantic/" class="nav-link">
  HTML
</a></li><li class="dropdown-subitem"><a href="/mblog/js/closures/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-subitem"><a href="/mblog/css/cssskill/" class="nav-link">
  CSS
</a></li><li class="dropdown-subitem"><a href="/mblog/node/node/" class="nav-link">
  Node
</a></li></ul></li><li class="dropdown-item"><h4>
          Framework
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mblog/vue/lifecycle/" class="nav-link">
  Vue
</a></li><li class="dropdown-subitem"><a href="/mblog/flutter/basic.html" class="nav-link">
  Flutter
</a></li></ul></li><li class="dropdown-item"><h4>
          Network
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mblog/network/http/" class="nav-link">
  HTTP
</a></li></ul></li><li class="dropdown-item"><h4>
          Plan
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mblog/plan/note/" class="nav-link">
  note
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="书籍" class="dropdown-title"><span class="title">书籍</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mblog/textbook/parsehttp/" class="nav-link">
  图解HTTP
</a></li><li class="dropdown-item"><!----> <a href="/mblog/textbook/computerNetworks/" class="nav-link">
  计算机网络教程
</a></li><li class="dropdown-item"><!----> <a href="/mblog/textbook/compute/" class="nav-link">
  计算的本质
</a></li><li class="dropdown-item"><!----> <a href="/mblog/textbook/advance/" class="nav-link">
  JS高级程序设计
</a></li></ul></div></div><div class="nav-item"><a href="/mblog/echo/echo/" class="nav-link">
  环境安装
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><span class="title">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Basic
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mblog/html/semantic/" class="nav-link">
  HTML
</a></li><li class="dropdown-subitem"><a href="/mblog/js/closures/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-subitem"><a href="/mblog/css/cssskill/" class="nav-link">
  CSS
</a></li><li class="dropdown-subitem"><a href="/mblog/node/node/" class="nav-link">
  Node
</a></li></ul></li><li class="dropdown-item"><h4>
          Framework
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mblog/vue/lifecycle/" class="nav-link">
  Vue
</a></li><li class="dropdown-subitem"><a href="/mblog/flutter/basic.html" class="nav-link">
  Flutter
</a></li></ul></li><li class="dropdown-item"><h4>
          Network
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mblog/network/http/" class="nav-link">
  HTTP
</a></li></ul></li><li class="dropdown-item"><h4>
          Plan
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/mblog/plan/note/" class="nav-link">
  note
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="书籍" class="dropdown-title"><span class="title">书籍</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mblog/textbook/parsehttp/" class="nav-link">
  图解HTTP
</a></li><li class="dropdown-item"><!----> <a href="/mblog/textbook/computerNetworks/" class="nav-link">
  计算机网络教程
</a></li><li class="dropdown-item"><!----> <a href="/mblog/textbook/compute/" class="nav-link">
  计算的本质
</a></li><li class="dropdown-item"><!----> <a href="/mblog/textbook/advance/" class="nav-link">
  JS高级程序设计
</a></li></ul></div></div><div class="nav-item"><a href="/mblog/echo/echo/" class="nav-link">
  环境安装
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>计算的本质</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mblog/textbook/compute.html#ruby" class="sidebar-link">ruby</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mblog/textbook/compute.html#_1-2-1-基本数据" class="sidebar-link">1.2.1 基本数据</a></li><li class="sidebar-sub-header"><a href="/mblog/textbook/compute.html#_1-2-2-数据结构" class="sidebar-link">1.2.2 数据结构</a></li><li class="sidebar-sub-header"><a href="/mblog/textbook/compute.html#_1-2-3-proc" class="sidebar-link">1.2.3 proc</a></li></ul></li><li><a href="/mblog/textbook/compute.html#_1-3-控制流" class="sidebar-link">1.3 控制流</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mblog/textbook/compute.html#_1-4-对象和方法" class="sidebar-link">1.4 对象和方法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mblog/textbook/compute.html#_1-5-类和模块" class="sidebar-link">1.5 类和模块</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mblog/textbook/compute.html#_1-6-其他特性" class="sidebar-link">1.6 其他特性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mblog/textbook/compute.html#_1-6-1-局部变量和赋值" class="sidebar-link">1.6.1 局部变量和赋值</a></li><li class="sidebar-sub-header"><a href="/mblog/textbook/compute.html#_1-6-2-字符串插值" class="sidebar-link">1.6.2 字符串插值</a></li><li class="sidebar-sub-header"><a href="/mblog/textbook/compute.html#_1-6-3-检查对象" class="sidebar-link">1.6.3 检查对象</a></li><li class="sidebar-sub-header"><a href="/mblog/textbook/compute.html#_1-6-4-打印字符串" class="sidebar-link">1.6.4 打印字符串</a></li><li class="sidebar-sub-header"><a href="/mblog/textbook/compute.html#_1-6-5-可变参数方法（variadic-method）" class="sidebar-link">1.6.5 可变参数方法（variadic method）</a></li><li class="sidebar-sub-header"><a href="/mblog/textbook/compute.html#_1-6-6-代码块" class="sidebar-link">1.6.6 代码块</a></li><li class="sidebar-sub-header"><a href="/mblog/textbook/compute.html#_1-6-7-枚举类型" class="sidebar-link">1.6.7 枚举类型</a></li><li class="sidebar-sub-header"><a href="/mblog/textbook/compute.html#_1-6-8-结构体" class="sidebar-link">1.6.8 结构体</a></li><li class="sidebar-sub-header"><a href="/mblog/textbook/compute.html#_1-6-9-给内置对象扩展方法（monkey-patching）" class="sidebar-link">1.6.9 给内置对象扩展方法（Monkey Patching）</a></li><li class="sidebar-sub-header"><a href="/mblog/textbook/compute.html#_1-6-10-定义常量" class="sidebar-link">1.6.10 定义常量</a></li><li class="sidebar-sub-header"><a href="/mblog/textbook/compute.html#_1-6-11-删除常量" class="sidebar-link">1.6.11 删除常量</a></li></ul></li><li><a href="/mblog/textbook/compute.html#_2-1-含义-的含义" class="sidebar-link">2.1“含义”的含义</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mblog/textbook/compute.html#_2-2-语法" class="sidebar-link">2.2 语法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mblog/textbook/compute.html#_2-3-操作语义" class="sidebar-link">2.3 操作语义</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mblog/textbook/compute.html#_2-3-1-小步语义" class="sidebar-link">2.3.1 小步语义</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="计算的本质"><a href="#计算的本质" class="header-anchor">#</a> 计算的本质</h1> <h2 id="ruby"><a href="#ruby" class="header-anchor">#</a> ruby</h2> <h3 id="_1-2-1-基本数据"><a href="#_1-2-1-基本数据" class="header-anchor">#</a> 1.2.1 基本数据</h3> <p>Ruby 支持布尔型（Boolean）、数值型（number）和字符串（string），且它们都支持常规运算</p> <p>一个 Ruby 符号表示一个名字，是一个轻量级、不可变的值。作为字符串的简单化、非内存密集化（less memory-intensive）的替身，符号在 Ruby 中被广泛使用——通常是作为散列表中的键使用（参见 1.2.2 节）。符号字面量的开头会有一个冒号</p> <p>eg:</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token symbol">:my_symbol</span>
</code></pre></div><h3 id="_1-2-2-数据结构"><a href="#_1-2-2-数据结构" class="header-anchor">#</a> 1.2.2 数据结构</h3> <p>Ruby 的数组字面量是一串用逗号分隔的值外加方括号的形式</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> numbers <span class="token operator">=</span>［<span class="token string">'zero'</span><span class="token punctuation">,</span><span class="token string">'one'</span><span class="token punctuation">,</span><span class="token string">'two'</span>］
</code></pre></div><p>范围（range）表示最小值和最大值之间值的集合。范围的写法是在两个值之间加两个点：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> ages <span class="token operator">=</span> <span class="token number">18.</span><span class="token number">.30</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">18.</span><span class="token number">.30</span>
</code></pre></div><p>一个散列（hash）表示一个集合，其中每个值都与一个键相关联；一些编程语言把这种数据结构叫作“映射”（map）、“字典”（dictionary）或者“关联数组”（associative array）。一个散列字面量写成大括号里用逗号分隔的“键 =&gt; 值”对的列表：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> fruit <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'a'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'apple'</span><span class="token punctuation">,</span><span class="token string">'b'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'banana'</span><span class="token punctuation">,</span><span class="token string">'c'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'coconut'</span> <span class="token punctuation">}</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token string">&quot;a&quot;</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">&quot;apple&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;b&quot;</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">&quot;banana&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;c&quot;</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">&quot;coconut&quot;</span><span class="token punctuation">}</span>
</code></pre></div><p>散列经常将符号用作键，所以键作为符号时，Ruby 提供了另一种书写键值对的语法。这种写法比“键 =&gt; 值”的方式更为紧凑，而且看起来很像常用于 JavaScript 对象的 JSON 格式：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> dimensions <span class="token operator">=</span> <span class="token punctuation">{</span> width<span class="token punctuation">:</span><span class="token number">1000</span><span class="token punctuation">,</span>height<span class="token punctuation">:</span><span class="token number">2250</span><span class="token punctuation">,</span>depth<span class="token punctuation">:</span><span class="token number">250</span> <span class="token punctuation">}</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token symbol">:width</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token symbol">:height</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token number">2250</span><span class="token punctuation">,</span><span class="token symbol">:depth</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token number">250</span><span class="token punctuation">}</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> dimensions<span class="token punctuation">[</span><span class="token symbol">:depth</span><span class="token punctuation">]</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">250</span>
</code></pre></div><h3 id="_1-2-3-proc"><a href="#_1-2-3-proc" class="header-anchor">#</a> 1.2.3 proc</h3> <p>一个 proc 是一段未经求值的 Ruby 代码，根据需要进行传递和求值；其他语言把这种语言结构称为“匿名函数”或“lambda 函数”。proc 字面量有多种写法，其中最紧凑的一种是“-&gt; 参数 { 函数体 }”语法：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> multiply <span class="token operator">=</span> <span class="token operator">-</span><span class="token operator">&gt;</span> x<span class="token punctuation">,</span>y <span class="token punctuation">{</span> x <span class="token operator">*</span> y <span class="token punctuation">}</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;Proc （lambda）&gt;</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> multiply<span class="token punctuation">.</span>call<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">54</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> multiply<span class="token punctuation">.</span>call<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">6</span>
</code></pre></div><p>除了 .call 语法，还可以使用方括号调用 proc：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> multiply<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">12</span>
</code></pre></div><h2 id="_1-3-控制流"><a href="#_1-3-控制流" class="header-anchor">#</a> 1.3 控制流</h2> <p>Ruby 有 if、case 和 while 表达式，它们都以通常的方式工作：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">if</span> <span class="token number">2</span> <span class="token operator">&lt;</span> <span class="token number">3</span>
  <span class="token string">'less'</span>
  <span class="token keyword">else</span>
  <span class="token string">'more'</span>
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;less&quot;</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> quantify <span class="token operator">=</span>
  <span class="token operator">-</span><span class="token operator">&gt;</span> number <span class="token punctuation">{</span>
  <span class="token keyword">case</span> number
  <span class="token keyword">when</span> <span class="token number">1</span>
  <span class="token string">'one'</span>
  <span class="token keyword">when</span> <span class="token number">2</span>
  <span class="token string">'a couple'</span>
  <span class="token keyword">else</span>
  <span class="token string">'many'</span>
  <span class="token keyword">end</span>
  <span class="token punctuation">}</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;Proc （lambda）&gt;</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> quantify<span class="token punctuation">.</span>call<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;a couple&quot;</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> quantify<span class="token punctuation">.</span>call<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;many&quot;</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> x <span class="token operator">=</span> <span class="token number">1</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">while</span> x <span class="token operator">&lt;</span> <span class="token number">1000</span>
  x <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token number">2</span>
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> x
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1024</span>
</code></pre></div><h2 id="_1-4-对象和方法"><a href="#_1-4-对象和方法" class="header-anchor">#</a> 1.4 对象和方法</h2> <p>Ruby 看起来和其他动态编程语言很像，但有一个重要的区别：每个值都是一个对象，而且对象彼此之间靠<strong>发送消息</strong>进行通信。每个对象都有自己的方法集合，这些方法决定了它如何响应特定的消息。</p> <p>（1）这种来自于编程语言 Smalltalk 的风格，对 Ruby 的设计有直接影响。</p> <p>一个消息有一个名字，并且根据需要可以有一些参数。一个对象收到一个消息的时候，它对应的方法就会使用消息中的参数作为自己的参数执行。这就是 Ruby 完成全部工作的方式；甚至“1 ＋ 2”都意味着“使用参数 2 给对象 1 发送一个叫作 ＋ 的消息”，而对象 1 有一个处理那个消息的方法 #＋。
我们可以使用关键字 def 定义自己的方法：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> o <span class="token operator">=</span> <span class="token builtin">Object</span><span class="token punctuation">.</span><span class="token keyword">new</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;Object&gt;</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token method-definition">o<span class="token punctuation">.</span><span class="token function">add</span></span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span>
  x ＋ y
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> o<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">5</span>
</code></pre></div><p>这里，我们通过向一个特殊内建对象 Object 发送 new 消息来新建一个对象；新对象创建之后，在其上定义了一个叫 #add 的方法。#add 方法把它的两个参数加在一起，并返回结果；因为一个方法中最后执行的表达式的值将被自动返回，所以并不需要一个显式的 return。在使用 2 和 3 作为参数向那个对象发送 add 消息之后，#add 方法就会执行，然后我们就得到了想要的结果。
通常情况下，在发送消息时要写上接收对象和消息名并用圆点分隔（例如 o.add），但是 Ruby 会一直追踪当前对象（叫作 self），这样在向当前对象发送消息时只需写上一个消息名，接收对象可以不必显式写出来。例如，在一个方法定义内部，当前对象总是接收消息并执行此方法的对象，因此在一个特定对象的方法内部，向同一个对象发送其他消息时，可以不必显式提及：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token method-definition">o<span class="token punctuation">.</span><span class="token function">add_twice</span></span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span>
  add<span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span> ＋ add<span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> o<span class="token punctuation">.</span>add_twice<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">10</span>
</code></pre></div><p>注意，我们在 #add_twice 方法里给 o 发送 add 消息时，可以不必写成 o.add（x，y），只写 add（x，y） 就可以，这是因为 o 是接收 add_twice 消息的对象。</p> <p>在所有的方法定义之外，当前对象是一个叫 main 的特殊顶层对象，任何没有指明接收者的消息都会被发送给它；同样，任何没有指明对象的方法定义都可以通过 main 使用：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">multiply</span></span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span>
  a <span class="token operator">*</span> b
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> multiply<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">6</span>
</code></pre></div><h2 id="_1-5-类和模块"><a href="#_1-5-类和模块" class="header-anchor">#</a> 1.5 类和模块</h2> <p>能在许多对象之间共享方法定义是件很便利的事。在 Ruby 中我们可以把方法定义放到一个类里，然后通过给那个类发送 new 消息来新建对象。所获得的对象是包括方法在内的这个类的实例。
例如：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">Calculator</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">divide</span></span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span>
  x <span class="token operator">/</span> y
  <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> c <span class="token operator">=</span> <span class="token constant">Calculator</span><span class="token punctuation">.</span><span class="token keyword">new</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;Calculator&gt;</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> c<span class="token punctuation">.</span><span class="token keyword">class</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token constant">Calculator</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> c<span class="token punctuation">.</span>divide<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">5</span>
</code></pre></div><p>注意，在一个类定义里定义一个方法会把方法添加到那个类的实例里，而不是加到 main 里：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> divide<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token constant">NoMethodError</span><span class="token symbol">:undefined</span> method `divide' <span class="token keyword">for</span> main：<span class="token builtin">Object</span>
</code></pre></div><p>一个类可以通过继承来引入另一个类的方法定义：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">MultiplyingCalculator</span> <span class="token operator">&lt;</span> <span class="token constant">Calculator</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">multiply</span></span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span>
  x <span class="token operator">*</span> y
  <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> mc <span class="token operator">=</span> <span class="token constant">MultiplyingCalculator</span><span class="token punctuation">.</span><span class="token keyword">new</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;MultiplyingCalculator&gt;</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> mc<span class="token punctuation">.</span><span class="token keyword">class</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token constant">MultiplyingCalculator</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> mc<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span>superclass
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token constant">Calculator</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> mc<span class="token punctuation">.</span>multiply<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">20</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> mc<span class="token punctuation">.</span>divide<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">5</span>
</code></pre></div><p>子类中的方法可以通过 super 关键字调用超类的同名方法：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">BinaryMultiplyingCalculator</span> <span class="token operator">&lt;</span> <span class="token constant">MultiplyingCalculator</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">multiply</span></span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span>
  result <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span>
  result<span class="token punctuation">.</span>to_s<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> bmc <span class="token operator">=</span> <span class="token constant">BinaryMultiplyingCalculator</span><span class="token punctuation">.</span><span class="token keyword">new</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;BinaryMultiplyingCalculator&gt;</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> bmc<span class="token punctuation">.</span>multiply<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;10100&quot;</span>
</code></pre></div><p>另一种共享方法定义的方式是在模块（module）中声明它们，这样它们就能被任意类包括进去：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">module</span> <span class="token constant">Addition</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">add</span></span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span>
  x ＋ y
  <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">AddingCalculator</span>
  <span class="token keyword">include</span> <span class="token constant">Addition</span>
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token constant">AddingCalculator</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> ac <span class="token operator">=</span> <span class="token constant">AddingCalculator</span><span class="token punctuation">.</span><span class="token keyword">new</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;AddingCalculator&gt;</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> ac<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">12</span>
</code></pre></div><h2 id="_1-6-其他特性"><a href="#_1-6-其他特性" class="header-anchor">#</a> 1.6 其他特性</h2> <h3 id="_1-6-1-局部变量和赋值"><a href="#_1-6-1-局部变量和赋值" class="header-anchor">#</a> 1.6.1 局部变量和赋值</h3> <p>就像我们已经看到的那样，Ruby 仅允许通过赋值声明局部变量：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> greeting <span class="token operator">=</span> <span class="token string">'hello'</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;hello&quot;</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> greeting
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;hello&quot;</span>
</code></pre></div><p>我们还可以通过数组一次给多个变量并行赋值：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> width<span class="token punctuation">,</span>height<span class="token punctuation">,</span>depth <span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">2250</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">]</span>
<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">2250</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">]</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> height
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">2250</span>
</code></pre></div><h3 id="_1-6-2-字符串插值"><a href="#_1-6-2-字符串插值" class="header-anchor">#</a> 1.6.2 字符串插值</h3> <p>字符串可以使用单引号也可以使用双引号表示。对双引号中的字符串，Ruby 会自动用表达式的结果替换 #{ 表达式 }，以执行字符串插值操作。</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token string">&quot;hello <span class="token interpolation"><span class="token delimiter tag">#{</span><span class="token string">'dlrow'</span><span class="token punctuation">.</span>reverse<span class="token delimiter tag">}</span></span>&quot;</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;hello world&quot;</span>
</code></pre></div><p>如果被插入的表达式返回的不是一个字符串类型的对象，那么这个对象就会自动收到一个 #to_s 消息以返回能顶替其位置的字符串。我们可以借此控制被替换对象的展示方式：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> o <span class="token operator">=</span> <span class="token builtin">Object</span><span class="token punctuation">.</span><span class="token keyword">new</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;Object&gt;</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token method-definition">o<span class="token punctuation">.</span><span class="token function">to_s</span></span>
  <span class="token string">'a new object'</span>
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token string">&quot;here is <span class="token interpolation"><span class="token delimiter tag">#{</span>o<span class="token delimiter tag">}</span></span>&quot;</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;here is a new object&quot;</span>
</code></pre></div><h3 id="_1-6-3-检查对象"><a href="#_1-6-3-检查对象" class="header-anchor">#</a> 1.6.3 检查对象</h3> <p>每当 IRB 需要显示一个对象，类似下面的一些事情就会发生：向这个对象发送 inspect 消息，然后这个对象返回自身的字符串表示。Ruby 当中所有对象默认都有对 #inspect 的合理实现，但是通过提供自己的定义，我们就可以控制如何在控制台显示对象：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> o <span class="token operator">=</span> <span class="token builtin">Object</span><span class="token punctuation">.</span><span class="token keyword">new</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;Object&gt;</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token method-definition">o<span class="token punctuation">.</span><span class="token function">inspect</span></span>
<span class="token string">'［my object］'</span>
<span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> o
<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>my object<span class="token punctuation">]</span>
</code></pre></div><h3 id="_1-6-4-打印字符串"><a href="#_1-6-4-打印字符串" class="header-anchor">#</a> 1.6.4 打印字符串</h3> <p>方法 #puts 对每个 Ruby 对象（包括 main）都可用，可以用来向标准输出打印字符串：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> x <span class="token operator">=</span> <span class="token number">128</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">128</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">while</span> x <span class="token operator">&lt;</span> <span class="token number">1000</span>
  puts <span class="token string">&quot;x is <span class="token interpolation"><span class="token delimiter tag">#{</span>x<span class="token delimiter tag">}</span></span>&quot;</span>
  x <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token number">2</span>
  <span class="token keyword">end</span>
x is <span class="token number">128</span>
x is <span class="token number">256</span>
x is <span class="token number">512</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
</code></pre></div><h3 id="_1-6-5-可变参数方法（variadic-method）"><a href="#_1-6-5-可变参数方法（variadic-method）" class="header-anchor">#</a> 1.6.5 可变参数方法（variadic method）</h3> <p>定义方法时可以使用 * 运算符，以支持数目可变的参数：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">join_with_commas</span></span><span class="token punctuation">(</span><span class="token operator">*</span>words<span class="token punctuation">)</span>
  words<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> join_with_commas<span class="token punctuation">(</span><span class="token string">'one'</span><span class="token punctuation">,</span><span class="token string">'two'</span><span class="token punctuation">,</span><span class="token string">'three'</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;one,two,three&quot;</span>
</code></pre></div><p>一个方法定义只能有一个可变参数，而常规参数放到可变参数的前后都可以：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">join_with_commas</span></span><span class="token punctuation">(</span>before<span class="token punctuation">,</span><span class="token operator">*</span>words<span class="token punctuation">,</span>after<span class="token punctuation">)</span>
  before ＋ words<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span> ＋ after
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> join_with_commas<span class="token punctuation">(</span><span class="token string">'Testing:'</span><span class="token punctuation">,</span><span class="token string">'one'</span><span class="token punctuation">,</span><span class="token string">'two'</span><span class="token punctuation">,</span><span class="token string">'three'</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;Testing:one,two,three.&quot;</span>
</code></pre></div><p>在发送消息的时候，* 运算符还可以把每一个数组元素当作单个参数处理：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> arguments <span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Testing:'</span><span class="token punctuation">,</span><span class="token string">'one'</span><span class="token punctuation">,</span><span class="token string">'two'</span><span class="token punctuation">,</span><span class="token string">'three'</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">]</span>
<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token string">&quot;Testing:&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;one&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;two&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;three&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">]</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> join_with_commas<span class="token punctuation">(</span><span class="token operator">*</span>arguments<span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;Testing:one,two,three.&quot;</span>
</code></pre></div><p>* 也可以使用并行赋值方式：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> before<span class="token punctuation">,</span><span class="token operator">*</span>words<span class="token punctuation">,</span>after <span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'Testing:'</span><span class="token punctuation">,</span><span class="token string">'one'</span><span class="token punctuation">,</span><span class="token string">'two'</span><span class="token punctuation">,</span><span class="token string">'three'</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">]</span>
<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token string">&quot;Testing:&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;one&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;two&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;three&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">]</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> before
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;Testing:&quot;</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> words
<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token string">&quot;one&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;two&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;three&quot;</span><span class="token punctuation">]</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> after
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;.&quot;</span>
</code></pre></div><h3 id="_1-6-6-代码块"><a href="#_1-6-6-代码块" class="header-anchor">#</a> 1.6.6 代码块</h3> <p>代码块（block)是由 do/end 或者大括号围住的一段 Ruby 代码。方法可以带一个隐式代码块参数，并使用 yield 关键字表示对代码块中那段代码的调用：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">do_three_times</span></span>
  <span class="token keyword">yield</span>
  <span class="token keyword">yield</span>
  <span class="token keyword">yield</span>
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> do_three_times <span class="token punctuation">{</span> puts <span class="token string">'hello'</span> <span class="token punctuation">}</span>
hello
hello
hello
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
</code></pre></div><p>代码块可以带参数：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">do_three_times</span></span>
  <span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token string">'first'</span><span class="token punctuation">)</span>
  <span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token string">'second'</span><span class="token punctuation">)</span>
  <span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token string">'third'</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> do_three_times <span class="token punctuation">{</span> <span class="token operator">|</span>n<span class="token operator">|</span> puts <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter tag">#{</span>n<span class="token delimiter tag">}</span></span>:hello&quot;</span> <span class="token punctuation">}</span>
first<span class="token symbol">:hello</span>
second<span class="token symbol">:hello</span>
third<span class="token symbol">:hello</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
</code></pre></div><p>yield 返回执行代码块的结果：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">number_names</span></span>
 <span class="token punctuation">[</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token string">'one'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token string">'two'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token string">'three'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> number_names <span class="token punctuation">{</span> <span class="token operator">|</span>name<span class="token operator">|</span> name<span class="token punctuation">.</span>upcase<span class="token punctuation">.</span>reverse <span class="token punctuation">}</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;ENO,OWT,EERHT&quot;</span>
</code></pre></div><h3 id="_1-6-7-枚举类型"><a href="#_1-6-7-枚举类型" class="header-anchor">#</a> 1.6.7 枚举类型</h3> <p>Ruby 有一个叫作 Enumerable 的内置模块，被数组（Array）、散列表（Hash）、范围（Range）以及其他表示值的集合的类包含。Enumerable 提供的方法可以帮助我们对集合进行遍历、搜索和排序，其中的很多方法在调用时都可以带上一个代码块。通常，代码块中的代码会根据集合中的一些值或全部值来运行，以此承担方法的一部分工作。例如：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">1.</span><span class="token number">.10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count <span class="token punctuation">{</span> <span class="token operator">|</span>number<span class="token operator">|</span> number<span class="token punctuation">.</span>even<span class="token operator">?</span> <span class="token punctuation">}</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">5</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">1.</span><span class="token number">.10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>select <span class="token punctuation">{</span> <span class="token operator">|</span>number<span class="token operator">|</span> number<span class="token punctuation">.</span>even<span class="token operator">?</span> <span class="token punctuation">}</span>
<span class="token operator">=</span><span class="token operator">&gt;</span>［<span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">10</span>］
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">1.</span><span class="token number">.10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>any<span class="token operator">?</span> <span class="token punctuation">{</span> <span class="token operator">|</span>number<span class="token operator">|</span> number <span class="token operator">&lt;</span> <span class="token number">8</span> <span class="token punctuation">}</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">1.</span><span class="token number">.10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>all<span class="token operator">?</span> <span class="token punctuation">{</span> <span class="token operator">|</span>number<span class="token operator">|</span> number <span class="token operator">&lt;</span> <span class="token number">8</span> <span class="token punctuation">}</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">1.</span><span class="token number">.5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>number<span class="token operator">|</span>
  <span class="token keyword">if</span> number<span class="token punctuation">.</span>even<span class="token operator">?</span>
  puts <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter tag">#{</span>number<span class="token delimiter tag">}</span></span> is even&quot;</span>
  <span class="token keyword">else</span>
  puts <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter tag">#{</span>number<span class="token delimiter tag">}</span></span> is odd&quot;</span>
  <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token number">1</span> is odd
<span class="token number">2</span> is even
<span class="token number">3</span> is odd
<span class="token number">4</span> is even
<span class="token number">5</span> is odd
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1.</span><span class="token number">.5</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">1.</span><span class="token number">.10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map <span class="token punctuation">{</span> <span class="token operator">|</span>number<span class="token operator">|</span> number <span class="token operator">*</span> <span class="token number">3</span> <span class="token punctuation">}</span>
<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">]</span>
</code></pre></div><p>通常，一个代码块带有一个参数，并向此参数发送一个无参的消息，所以 Ruby 提供了一种缩写方式 &amp;：message，这比写代码块 { |object| object.message } 更为简洁：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">1.</span><span class="token number">.10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token symbol">:even?</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">]</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token string">'one'</span><span class="token punctuation">,</span><span class="token string">'two'</span><span class="token punctuation">,</span><span class="token string">'three'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token symbol">:upcase</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token string">&quot;ONE&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;TWO&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;THREE&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p>有的代码块可以为集合中的每个值生成一个数组，Enumerable 的方法 #flat_map 能把这些生成的结果数组连接起来：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token string">'one'</span><span class="token punctuation">,</span><span class="token string">'two'</span><span class="token punctuation">,</span><span class="token string">'three'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token symbol">:chars</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;o&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;n&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;e&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">&quot;t&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;w&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;o&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">&quot;t&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;h&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;r&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;e&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;e&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token string">'one'</span><span class="token punctuation">,</span><span class="token string">'two'</span><span class="token punctuation">,</span><span class="token string">'three'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>flat_map<span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token symbol">:chars</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token string">&quot;o&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;n&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;e&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;t&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;w&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;o&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;t&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;h&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;r&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;e&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;e&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p>还有一个有用的方法 #inject。有些代码块会处理集合中的每个值，#inject 能对这个代码块求值并累积成一个最终结果：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">1.</span><span class="token number">.10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>inject<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">|</span>result<span class="token punctuation">,</span>number<span class="token operator">|</span> result ＋ number <span class="token punctuation">}</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">55</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token number">1.</span><span class="token number">.10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>inject<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">|</span>result<span class="token punctuation">,</span>number<span class="token operator">|</span> result <span class="token operator">*</span> number <span class="token punctuation">}</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">3628800</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token string">'one'</span><span class="token punctuation">,</span><span class="token string">'two'</span><span class="token punctuation">,</span><span class="token string">'three'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>inject<span class="token punctuation">(</span><span class="token string">'Words:'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">|</span>result<span class="token punctuation">,</span>word<span class="token operator">|</span> <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter tag">#{</span>result<span class="token delimiter tag">}</span></span> <span class="token interpolation"><span class="token delimiter tag">#{</span>word<span class="token delimiter tag">}</span></span>&quot;</span> <span class="token punctuation">}</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;Words:one two three&quot;</span>
</code></pre></div><h3 id="_1-6-8-结构体"><a href="#_1-6-8-结构体" class="header-anchor">#</a> 1.6.8 结构体</h3> <p>结构体（Struct）是 Ruby 中一个特殊的类，它的工作是生成其他类。根据传进 Struct.new 的每个属性名，Struct 产成的类会包含相应的获取方法和设置方法。要使用由结构体生成的类，常见方式是对其进行子类化；我们可以给子类起个名字，然后在里边定义其他任意的方法。例如，为了创建一个拥有属性 x 和 y，名字是 Point 的类，可以写成：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:x</span><span class="token punctuation">,</span><span class="token symbol">:y</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> ＋<span class="token punctuation">(</span>other_point<span class="token punctuation">)</span>
  <span class="token constant">Point</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>x ＋ other_point<span class="token punctuation">.</span>x<span class="token punctuation">,</span>y ＋ other_point<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">inspect</span></span>
  <span class="token string">&quot;#&lt;Point (<span class="token interpolation"><span class="token delimiter tag">#{</span>x<span class="token delimiter tag">}</span></span>,<span class="token interpolation"><span class="token delimiter tag">#{</span>y<span class="token delimiter tag">}</span></span>)&gt;&quot;</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre></div><p>现在我们可以创建 Point 的一些实例，然后在 IRB 中进行检查，并给它们发送消息：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> a <span class="token operator">=</span> <span class="token constant">Point</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;Point (2,3)&gt;</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> b <span class="token operator">=</span> <span class="token constant">Point</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;Point (10,20)&gt;</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> a ＋ b
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;Point (12,23)&gt;</span>
</code></pre></div><p>和我们定义的所有方法一样，Point 实例会响应消息 x 和 x=，以便获取和设置属性 x 的值。
y 和 y= 与 x 和 x= 的情况类似：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> a<span class="token punctuation">.</span>x
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">2</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> a<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">35</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">35</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> a ＋ b
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;Point (45，23)&gt;</span>
</code></pre></div><p>由 Struct.new 生成的类还有其他实用功能，像判断是否相等的方法 #== 的实现，就可以比较两个结构体的属性是否相等：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token constant">Point</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">Point</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token constant">Point</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">Point</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>
</code></pre></div><h3 id="_1-6-9-给内置对象扩展方法（monkey-patching）"><a href="#_1-6-9-给内置对象扩展方法（monkey-patching）" class="header-anchor">#</a> 1.6.9 给内置对象扩展方法（Monkey Patching）</h3> <p>我们随时都可以给类或模块增加方法。这是一个强大的特性，通常叫作 Monkey Patching，可以让我们扩展已有类的行为：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">Point</span>
  <span class="token keyword">def</span> <span class="token operator">-</span> <span class="token punctuation">(</span>other_point<span class="token punctuation">)</span>
  <span class="token constant">Point</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>x <span class="token operator">-</span> other_point<span class="token punctuation">.</span>x<span class="token punctuation">,</span>y <span class="token operator">-</span> other_point<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token constant">Point</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token constant">Point</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;Point (9,14)&gt;</span>
</code></pre></div><p>我们甚至可以扩展 Ruby 内置的类：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">String</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">shout</span></span>
  upcase ＋ <span class="token string">'!!!'</span>
  <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token string">'hello world'</span><span class="token punctuation">.</span>shout
<span class="token operator">=</span><span class="token operator">&gt;</span> &quot;<span class="token constant">HELLO</span> <span class="token constant">WORLD!</span><span class="token operator">!</span><span class="token operator">!</span>“
</code></pre></div><h3 id="_1-6-10-定义常量"><a href="#_1-6-10-定义常量" class="header-anchor">#</a> 1.6.10 定义常量</h3> <p>Ruby 支持一种叫作常量的特殊变量。一般而言，常量一旦创建，就不能再被重新赋值。（Ruby 并不会阻止一个常量被重新赋值，但它会产生警告，以便我们知道自己做错了事。）任何以大写字母开头的变量都是常量。可以在顶层或者在一个类或模块中定义新的常量：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token constant">NUMBERS</span> <span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">]</span>
<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">]</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">Greetings</span>
  <span class="token constant">ENGLISH</span> <span class="token operator">=</span> <span class="token string">'hello'</span>
  <span class="token constant">FRENCH</span> <span class="token operator">=</span> <span class="token string">'bonjour'</span>
  <span class="token constant">GERMAN</span> <span class="token operator">=</span> <span class="token string">'guten Tag'</span>
  <span class="token keyword">end</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;guten Tag&quot;</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token constant">NUMBERS</span><span class="token punctuation">.</span>last
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">42</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token constant">Greetings</span><span class="token symbol">:FRENCH</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;bonjour&quot;</span>
</code></pre></div><p>类和模块的名字总是以大写字母开头，所以类和模块的名字也是常量。</p> <h3 id="_1-6-11-删除常量"><a href="#_1-6-11-删除常量" class="header-anchor">#</a> 1.6.11 删除常量</h3> <p>在使用 IRB 进行探索时，如果我们想重新定义某个类或模块，而不是要扩展它们，实用的做法是让 Ruby 完全忽略该常量。一个顶层常量可以通过给 Object 发送消息 remove_const 来删除，同时还要把常量名作为符号（symbol）对象传进去：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token constant">NUMBERS</span><span class="token punctuation">.</span>last
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">42</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">Object</span><span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token symbol">:remove_const</span><span class="token punctuation">,</span><span class="token symbol">:NUMBERS</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">]</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token constant">NUMBERS</span><span class="token punctuation">.</span>last
<span class="token constant">NameError</span><span class="token symbol">:uninitialized</span> constant <span class="token constant">NUMBERS</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token constant">Greetings</span><span class="token symbol">:GERMAN</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&quot;guten Tag&quot;</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token builtin">Object</span><span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token symbol">:remove_const</span><span class="token punctuation">,</span><span class="token symbol">:Greetings</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token constant">Greetings</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token constant">Greetings</span><span class="token symbol">:GERMAN</span>
<span class="token constant">NameError</span><span class="token symbol">:uninitialized</span> constant <span class="token constant">Greetings</span>
</code></pre></div><p>只能使用 Object.send（：remove_const，：常量名 ） 而非 Object.remove_const（：常量名 ），这是因为 remove_const 是一个私有（private）方法，只能通过从 Object 类的自身内部发送消息来调用；使用 Object.send 时，我们可以暂时跳过这个限制。</p> <h2 id="_2-1-含义-的含义"><a href="#_2-1-含义-的含义" class="header-anchor">#</a> 2.1“含义”的含义</h2> <p>为了完整地定义编程语言，我们需要：语法，描述程序看起来是什么样的；语义（semantics），描述程序的含义。</p> <h2 id="_2-2-语法"><a href="#_2-2-语法" class="header-anchor">#</a> 2.2 语法</h2> <p>传统的计算机程序是长长的字符串。每一种编程语言都有一系列规则，描述在那种语言中什么样的字符串被认为是有效程序。这些规则定义了这种语言的语法。</p> <p>通过语言的语法规则，我们能把像 y = x ＋ 1 这样可能有效的程序与像 &gt;/;x：1@4 这样毫无意义的字符串区分开。语法规则还为如何阅读一些具有二义性的程序提供了有用信息，例如运算符优先级的规则能够自动判定 1 ＋ 2 * 3 按其本意 1 ＋ （2 * 3）处理，而不是按（1 ＋ 2） * 3 处理。</p> <p>当然，计算机程序的预期用途是被计算机读取，而要读程序就需要语法解析器：这个分析器程序能够读取代表程序的字符串，根据语法规则检查它是否有效，然后把它转换成一个适合被进一步处理的结构化表示。</p> <p>有各种各样的工具能把一种语言的语法规则自动转换成一个语法解析器。具体如何对这些规则进行定义，以及把它们转成可用语法解析器的技术，并不是本章的讲解重点（2.6 节进行了简单介绍），但总体来讲一个语法解析器应该读入像 y = x ＋ 1 这样的字符串，然后把它转换成抽象语法树（AST）。抽象语法树是源代码的一种表示，去掉了空格之类的无关细节，而只关注程序的分层结构。</p> <p>语法关心的只是程序的表面是什么样的，而不是它的含义。程序有可能语法正确但没有任何实际意义。例如，程序 y = x ＋ 1 本身可能没有任何意义，因为并没有事先说明 x 是什么，而程序 z = true ＋ 1 可能会在运行时候报错，因为它试图在一个布尔型值上加数字。（当然，这依赖于具体编程语言的其他属性。）</p> <p>正如我们所料，能说明如何把一种编程语言的语法与这个语法暗含的语义对应起来的“唯一正途”并不存在。实际上，关于程序的含义有几种不同的研究方法，它们都在形式化（formality）、抽象度（abstraction）、可表达性（expressiveness）和实际效率（efficiency）之间做了权衡。在接下来的几节里，我们将看到这些主要的形式化方法，并了解它们之间的联系。</p> <h2 id="_2-3-操作语义"><a href="#_2-3-操作语义" class="header-anchor">#</a> 2.3 操作语义</h2> <p>考虑程序含义的最实际方法是思考它做了些什么：在运行程序的时候，我们期望发生什么呢？在运行时编程语言中不同的结构都是如何表现的？把它们放到一起组成更大的程序时会是什么效果？</p> <p>这是操作语义学（operational semantic）的基础，这种方法为程序在某种机器上的执行定义一些规则，以此来捕捉编程语言的含义。这个机器常常是一种抽象的机器：为了解释这种语言所写的程序如何执行而设计出来的一个想象的、理想化的计算机。为了更好地捕获编程语言的运行时行为，通常需要针对不同种类的编程语言设计不同的抽象机器。</p> <p>有了操作语义，我们可以朝着严谨而准确地研究语言中特定结构的目标前进了。用英语写成的语言规范可能暗藏着二义性，并且可能遗漏边缘情况，但一个形式化的操作性规范不会如此，为了令人信服地传达语言的行为，它必须明确而且无二义性。</p> <h2 id="_2-3-1-小步语义"><a href="#_2-3-1-小步语义" class="header-anchor">#</a> 2.3.1 小步语义</h2> <ol><li>表达式
例如，下面是 Number、Add 和 Multiply 三个类的定义：</li></ol> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">Number</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:value</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">Add</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:left</span><span class="token punctuation">,</span><span class="token symbol">:right</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">Multiply</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:left</span><span class="token punctuation">,</span><span class="token symbol">:right</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
</code></pre></div><p>实例化这些类来手工构造抽象语法树：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token constant">Add</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>
  <span class="token constant">Multiply</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">Multiply</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;struct Add</span>
  left<span class="token operator">=</span><span class="token comment">#&lt;struct Multiply</span>
  left<span class="token operator">=</span><span class="token comment">#&lt;struct Number value=1&gt;,</span>
  right<span class="token operator">=</span><span class="token comment">#&lt;struct Number value=2&gt;</span>
  <span class="token operator">&gt;</span><span class="token punctuation">,</span>
  right<span class="token operator">=</span><span class="token comment">#&lt;struct Multiply</span>
  left<span class="token operator">=</span><span class="token comment">#&lt;struct Number value=3&gt;,</span>
  right<span class="token operator">=</span><span class="token comment">#&lt;struct Number value=4&gt;</span>
  <span class="token operator">&gt;</span>
<span class="token operator">&gt;</span>
</code></pre></div><p>￼ 当然，最终我们想通过一个语法解析器自动构建这些树。2.6 节将介绍如何完成这件事情。</p> <p>三个类（Number、Add 和 Multiply）都继承了 Struct 对 #inspect 的通用定义，所以在 IRB 中它们实例的字符串表示会含有大量不重要的细节。为了方便在 IRB 中查看抽象语法树的内容，我们将覆盖每个类的 #inspect 方法 4，让它返回自定义的字符串表示：
（4）为了让代码保持简单，我们将抑制住把公共代码提取到超类或者模块中的欲望。</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">Number</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">to_s</span></span>
      value<span class="token punctuation">.</span>to_s
      <span class="token keyword">end</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">inspect</span></span>
      <span class="token string">&quot;«<span class="token interpolation"><span class="token delimiter tag">#{</span><span class="token keyword">self</span><span class="token delimiter tag">}</span></span>»&quot;</span>
      <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">Add</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">to_s</span></span>
      <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter tag">#{</span>left<span class="token delimiter tag">}</span></span> ＋ <span class="token interpolation"><span class="token delimiter tag">#{</span>right<span class="token delimiter tag">}</span></span>&quot;</span>
      <span class="token keyword">end</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">inspect</span></span>
      <span class="token string">&quot;«<span class="token interpolation"><span class="token delimiter tag">#{</span><span class="token keyword">self</span><span class="token delimiter tag">}</span></span>»&quot;</span>
      <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">Multiply</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">to_s</span></span>
      <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter tag">#{</span>left<span class="token delimiter tag">}</span></span> * <span class="token interpolation"><span class="token delimiter tag">#{</span>right<span class="token delimiter tag">}</span></span>&quot;</span>
      <span class="token keyword">end</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">inspect</span></span>
      <span class="token string">&quot;«<span class="token interpolation"><span class="token delimiter tag">#{</span><span class="token keyword">self</span><span class="token delimiter tag">}</span></span>»&quot;</span>
      <span class="token keyword">end</span>
  <span class="token keyword">end</span>
</code></pre></div><p>这样每个抽象语法树都将在 IRB 中以 Simple 源代码的形式呈现，外边会加上书名号（«»）以便与正常的 Ruby 值区分。</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token constant">Add</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>
  <span class="token constant">Multiply</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">Multiply</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> «<span class="token number">1</span> <span class="token operator">*</span> <span class="token number">2</span> ＋ <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">4</span>»
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> «<span class="token number">5</span>»
</code></pre></div><p>我们对#to_s 的基本实现并没有把运算优先级考虑进来，所以有时候如果按照传统的优先级规则（例如 * 通常比 ＋ 优先级更高）它们的输出是不正确的。以下面的抽象语法树为例：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span> <span class="token constant">Multiply</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>
  <span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">Multiply</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>
  <span class="token constant">Add</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> «<span class="token number">1</span> <span class="token operator">*</span> <span class="token number">2</span> ＋ <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">4</span>»
</code></pre></div><p>这棵树表示«1 * （2 ＋ 3） * 4»与«1 * 2 ＋ 3 * 4» 不是一个表达式（具有不同的含义），但字符串表示并没有反映出这一点。</p> <p>现在为抽象语法树定义规约方法，这将是我们实现一个小步操作语义的起点。也就是说，代码可以以一个抽象语法树作为输入，然后生成一个规约树作为输出。
在实现规约本身之前，我们先要区分什么样的表达式能规约，什么样的表达式不能规约。Add 和 Multiply 表达式总是能规约的（它们的每一个表达式都表示一个操作，并能够通过那种操作对应的计算变成一个结果），但是 Number 表达式总是代表一个值，它就不能规约成任何其他东西了。
原则上，我们可以使用简单的#reducible?断言把这两种表达式区分开，它能判断参数是否可规约，并返回 true 或者 false：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">def</span> <span class="token method-definition"><span class="token function">reducible</span></span><span class="token operator">?</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span>
    <span class="token keyword">case</span> expression
        <span class="token keyword">when</span> <span class="token constant">Number</span>
          <span class="token boolean">false</span>
        <span class="token keyword">when</span> <span class="token constant">Add</span><span class="token punctuation">,</span><span class="token constant">Multiply</span>
          <span class="token boolean">true</span>
      <span class="token keyword">end</span>
  <span class="token keyword">end</span>
</code></pre></div><p>但是，在一种面向对象语言里这么写代码通常被认为是不好的做法；如果一些运算的行为依赖于它参数的类型，典型的做法是将这种每个类都有的行为实现为它们的实例方法，从而让语言隐式地决定调用哪个方法，而不是使用显式的 case 语句。</p> <p>因此，我们将分别为 Number、Add 和 Multiply 实现 #reducible? 方法：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">Number</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">reducible</span></span><span class="token operator">?</span>
        <span class="token boolean">false</span>
      <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">Add</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">reducible</span></span><span class="token operator">?</span>
        <span class="token boolean">true</span>
      <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">Multiply</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">reducible</span></span><span class="token operator">?</span>
        <span class="token boolean">true</span>
      <span class="token keyword">end</span>
  <span class="token keyword">end</span>
</code></pre></div><p>这回的表现正是我们想要的：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reducible<span class="token operator">?</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token constant">Add</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reducible<span class="token operator">?</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
</code></pre></div><p>现在可以为这些表达式实现规约了：像上面一样，我们为 Add 和 Multiply 定义一个#reduce 方法。既然数字不能再规约，那就没有必要定义 Number#reduce 了，因此除非确切知道一个表达式能够规约，否则不要对其调用#reduce 方法。</p> <p>那么规约加法表达式的规则是什么呢？如果左右参数都是数字，那我们就能把它们加到一起，但如果其中一个或者所有参数需要规约怎么办？既然我们在考虑一小步一小步地进行规约，那就有必要在它们都符合规约条件的时候决定哪个参数先进行规约[^first]。一个常用的策略是按照从左到右的顺序对参数进行规约，规则是这样的：</p> <p>[^first] 选择什么顺序并没有区别，但是在这个时候我们必须做出决策。</p> <p>如果加法左边的参数能够规约，就规约左边的参数；</p> <p>如果加法左边的参数不能规约，但是右边的参数可以规约，就规约右边的参数；</p> <p>如果两边都不能规约，它们应该都是数字了，就把它们加到一起。</p> <p>上面这些规则的结构是小步规约操作语义的特征。每一个规则都提供了它能得以应用的表达式模式（左边参数可规约的加法，右边参数可规约的加法，两边参数分别都不能规约的加法），还有对当模式匹配上之后如何构建一个规约后的新表达式的描述。选择了这些特定的规则之后，我们不仅确定了那些参数分别规约好之后应该如何合并到一起，还特别指出了一个 Simple 表达式要使用从左到右求值的方法对参数进行规约。</p> <p>我们可以把这些规则直接翻译成一个 Add#reduce 的实现，同样的代码对 Multiply#reduce 也适用（别忘了要把参数乘起来而不是加起来）：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">Add</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">reduce</span></span>
        <span class="token keyword">if</span> left<span class="token punctuation">.</span>reducible<span class="token operator">?</span>
            <span class="token constant">Add</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>reduce<span class="token punctuation">,</span>right<span class="token punctuation">)</span>
          <span class="token keyword">elsif</span> right<span class="token punctuation">.</span>reducible<span class="token operator">?</span>
            <span class="token constant">Add</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span>right<span class="token punctuation">.</span>reduce<span class="token punctuation">)</span>
          <span class="token keyword">else</span>
            <span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>value <span class="token operator">+</span> right<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">Multiply</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">reduce</span></span>
        <span class="token keyword">if</span> left<span class="token punctuation">.</span>reducible<span class="token operator">?</span>
            <span class="token constant">Multiply</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>reduce<span class="token punctuation">,</span>right<span class="token punctuation">)</span>
          <span class="token keyword">elsif</span> right<span class="token punctuation">.</span>reducible<span class="token operator">?</span>
            <span class="token constant">Multiply</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span>right<span class="token punctuation">.</span>reduce<span class="token punctuation">)</span>
          <span class="token keyword">else</span>
            <span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>value <span class="token operator">*</span> right<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>
  <span class="token keyword">end</span>
</code></pre></div><p>方法 #reduce 总是构建出新的表达式，而不是对已有的表达式进行修改。为这几种表达式实现了 #reduce 方法之后，我们可以反复对其进行调用，从而通过很多的一小步来完整地求出表达式的值：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> expression <span class="token operator">=</span>
  <span class="token constant">Add</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>
  <span class="token constant">Multiply</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">Multiply</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> «<span class="token number">1</span> <span class="token operator">*</span> <span class="token number">2</span> ＋ <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">4</span>»
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> expression<span class="token punctuation">.</span>reducible<span class="token operator">?</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> expression <span class="token operator">=</span> expression<span class="token punctuation">.</span>reduce
<span class="token operator">=</span><span class="token operator">&gt;</span> «<span class="token number">2</span> ＋ <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">4</span>»
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> expression<span class="token punctuation">.</span>reducible<span class="token operator">?</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> expression <span class="token operator">=</span> expression<span class="token punctuation">.</span>reduce
<span class="token operator">=</span><span class="token operator">&gt;</span> «<span class="token number">2</span> ＋ <span class="token number">12</span>»
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> expression<span class="token punctuation">.</span>reducible<span class="token operator">?</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> expression <span class="token operator">=</span> expression<span class="token punctuation">.</span>reduce
<span class="token operator">=</span><span class="token operator">&gt;</span> «<span class="token number">14</span>»
<span class="token operator">&gt;</span><span class="token operator">&gt;</span> expression<span class="token punctuation">.</span>reducible<span class="token operator">?</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>
</code></pre></div><p>注意，#reduce 总是把一个表达式转换成另一个表达式，这正是小步规约操作语义应该遵守的规则。特别要注意的是，Add.new（Number.new（2），Number.new（12））.reduce 返回的 Number.new（14） 表示 Simple 表达式，而不仅仅是 14 这个 Ruby 中的数字。</p> <p>Simple 语言（我们正在为其定义语义）和 Ruby 元语言（我们正在使用它定义语义）在明显不同的时候区分起来很容易——就像元语言是数学符号而不是一种程序设计语言时一样容易区分——但是这里因为两种语言看起来很像，所以需要更加小心。</p> <p>我们在维护着一个状态——也就是当前表达式——并且对其反复调用 #reducible? 和#reduce，直到得到了一个值为止，通过这种方式，可以手工模拟一个抽象机器对表达式求值的操作。为了节省点力气，也为了让这个抽象机器的思想更为具体，我们可以轻松地写些 Ruby 代码。把这些代码和状态封装到一个类里，并称为虚拟机：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">Machine</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:expression</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">step</span></span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>expression <span class="token operator">=</span> expression<span class="token punctuation">.</span>reduce
      <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">run</span></span>
    <span class="token keyword">while</span> expression<span class="token punctuation">.</span>reducible<span class="token operator">?</span>
        puts expression
        step
        <span class="token keyword">end</span>
      puts expression
      <span class="token keyword">end</span>
  <span class="token keyword">end</span>
</code></pre></div><p>这允许我们用一个表达式实例化一个虚拟机，让它运行（#run），并观察逐渐规约的各个步骤：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token constant">Machine</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>
  <span class="token constant">Add</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>
  <span class="token constant">Multiply</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">Multiply</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span>run
<span class="token number">1</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">4</span>
<span class="token number">2</span> <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token number">4</span>
<span class="token number">2</span> <span class="token operator">+</span> <span class="token number">12</span>
<span class="token number">14</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
</code></pre></div><p>要扩展这个实现以支持其他简单的值和运算并不难：减法和除法，布尔值 true 和 false，布尔运算 and、or 和 not，对数字进行比较并返回布尔值的运算，等等。例如，下面是一个布尔值以及小于运算的实现：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">Boolean</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:value</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">to_s</span></span>
          value<span class="token punctuation">.</span>to_s
        <span class="token keyword">end</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">inspect</span></span>
          <span class="token string">&quot;«<span class="token interpolation"><span class="token delimiter tag">#{</span><span class="token keyword">self</span><span class="token delimiter tag">}</span></span>»&quot;</span>
        <span class="token keyword">end</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">reducible</span></span><span class="token operator">?</span>
          <span class="token boolean">false</span>
        <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">LessThan</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:left</span><span class="token punctuation">,</span><span class="token symbol">:right</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">to_s</span></span>
          <span class="token string">&quot;<span class="token interpolation"><span class="token delimiter tag">#{</span>left<span class="token delimiter tag">}</span></span> &lt; <span class="token interpolation"><span class="token delimiter tag">#{</span>right<span class="token delimiter tag">}</span></span>&quot;</span>
        <span class="token keyword">end</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">inspect</span></span>
          <span class="token string">&quot;«<span class="token interpolation"><span class="token delimiter tag">#{</span><span class="token keyword">self</span><span class="token delimiter tag">}</span></span>»&quot;</span>
        <span class="token keyword">end</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">reducible</span></span><span class="token operator">?</span>
          <span class="token boolean">true</span>
        <span class="token keyword">end</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">reduce</span></span>
          <span class="token keyword">if</span> left<span class="token punctuation">.</span>reducible<span class="token operator">?</span>
              <span class="token constant">LessThan</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>reduce<span class="token punctuation">,</span>right<span class="token punctuation">)</span>
            <span class="token keyword">elsif</span> right<span class="token punctuation">.</span>reducible<span class="token operator">?</span>
              <span class="token constant">LessThan</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span>right<span class="token punctuation">.</span>reduce<span class="token punctuation">)</span>
            <span class="token keyword">else</span>
              <span class="token constant">Boolean</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>value <span class="token operator">&lt;</span> right<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
          <span class="token keyword">end</span>
        <span class="token keyword">end</span>
  <span class="token keyword">end</span>
</code></pre></div><p>这仍然允许我们一小步一小步地规约布尔表达式：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token constant">Machine</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>
<span class="token constant">LessThan</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">Add</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span>run
<span class="token number">5</span> <span class="token operator">&lt;</span> <span class="token number">2</span> ＋ <span class="token number">2</span>
<span class="token number">5</span> <span class="token operator">&lt;</span> <span class="token number">4</span>
<span class="token boolean">false</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">nil</span>
</code></pre></div><p>目前为止都是直截了当的东西：我们通过实现能对一种语言求值的虚拟机来定义它的操作语义。虚拟机当前的状态就是当前的表达式，而机器的行为是由一个规则集合来描述的，这个规则集合负责管理机器运行时的状态切换。我们已经把机器实现成了程序，这个程序跟踪当前表达式，持续对其进行规约，并随之更新表达式，直到没有更进一步的规约可以继续执行为止。</p> <p>但是这种由简单代数表达式组成的语言不是十分有趣，这种语言没有几个我们期望拥有的哪怕是最简单编程语言中的特性。接下来我们把它构建得更复杂一些，让它看起来更像是一种能写出有用程序的语言。</p> <p>首先，Simple 有一个明显缺失的东西：变量。在任何有用的语言中，我们都期望在讨论值时能够使用有意义的名字而不是它们本身的字面值。这些名字提供了一个间接层，这样同一个代码可以用来处理很多不同的值——包括来自于程序外部因而在写代码时甚至都不知道的值。</p> <p>我们可以引入一个新的表达式类 Variable 来表示 Simple 中的变量：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">Variable</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:name</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">to_s</span></span>
        name<span class="token punctuation">.</span>to_s
      <span class="token keyword">end</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">inspect</span></span>
      <span class="token string">&quot;«<span class="token interpolation"><span class="token delimiter tag">#{</span><span class="token keyword">self</span><span class="token delimiter tag">}</span></span>»&quot;</span>
      <span class="token keyword">end</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">reducible</span></span><span class="token operator">?</span>
        <span class="token boolean">true</span>
      <span class="token keyword">end</span>
  <span class="token keyword">end</span>
</code></pre></div><p>为了能规约一个变量，抽象机器不仅仅需要存储当前表达式，还要存储从变量名称到它们值的映射——环境（environment）。在 Ruby 中，我们可以把这个映射实现成一个散列表（hash），其中用符号作为键，用表达式对象作为值；例如，散列表 <code>{x:Number.new(2),y:Boolean.new(false) }</code> 是一个环境，它分别把变量 x和y 与 Simple 的数字和布尔值进行了关联。</p> <p>对这种语言来说，环境的目的只是把变量名映射到<code>Number.new(2)</code> 这样不可规约的值上，而不是映射到 <code>Add.new(Number.new(1),Number.new(2))</code> 这样可以规约的表达式。稍后我们编写能改变环境的规则时要注意这个约束。</p> <p>有了环境，我们很容易实现 Variable#reduce:它只是在环境里查找变量的名字并返回其值。</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">Variable</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">reduce</span></span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span>
  environment<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre></div><p>注意，我们正在把一个环境作为参数传进 #reduce，所以需要修改其他类的 #reduce 的实现，以便能接受和提供这个参数：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token keyword">class</span> <span class="token class-name">Add</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">reduce</span></span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span>
        <span class="token keyword">if</span> left<span class="token punctuation">.</span>reducible<span class="token operator">?</span>
            <span class="token constant">Add</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>reduce<span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">,</span>right<span class="token punctuation">)</span>
          <span class="token keyword">elsif</span> right<span class="token punctuation">.</span>reducible<span class="token operator">?</span>
            <span class="token constant">Add</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span>right<span class="token punctuation">.</span>reduce<span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">else</span>
            <span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>value ＋ right<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">Multiply</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">reduce</span></span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span>
        <span class="token keyword">if</span> left<span class="token punctuation">.</span>reducible<span class="token operator">?</span>
            <span class="token constant">Multiply</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>reduce<span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">,</span>right<span class="token punctuation">)</span>
          <span class="token keyword">elsif</span> right<span class="token punctuation">.</span>reducible<span class="token operator">?</span>
            <span class="token constant">Multiply</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span>right<span class="token punctuation">.</span>reduce<span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">else</span>
            <span class="token constant">Number</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>value <span class="token operator">*</span> right<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">LessThan</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">reduce</span></span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span>
        <span class="token keyword">if</span> left<span class="token punctuation">.</span>reducible<span class="token operator">?</span>
            <span class="token constant">LessThan</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>reduce<span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">,</span>right<span class="token punctuation">)</span>
          <span class="token keyword">elsif</span> right<span class="token punctuation">.</span>reducible<span class="token operator">?</span>
            <span class="token constant">LessThan</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span>right<span class="token punctuation">.</span>reduce<span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">else</span>
            <span class="token constant">Boolean</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>value <span class="token operator">&lt;</span> right<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>
  <span class="token keyword">end</span>
</code></pre></div><p>现在 #reduce 的所有实现在更新之后都已经能支持环境了，因此还需要重新定义虚拟机，以便维持一个环境并把它提供给 #reduce：</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code><span class="token builtin">Object</span><span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token symbol">:remove_const</span><span class="token punctuation">,</span><span class="token symbol">:Machine</span><span class="token punctuation">)</span><span class="token comment"># 忘记原来的 Machine 类</span>
<span class="token keyword">class</span> <span class="token class-name">Machine</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:expression</span><span class="token punctuation">,</span><span class="token symbol">:environment</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">step</span></span>
  <span class="token keyword">self</span><span class="token punctuation">.</span>expression <span class="token operator">=</span> expression<span class="token punctuation">.</span>reduce<span class="token punctuation">(</span>environment<span class="token punctuation">)</span>
<span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">run</span></span>
    <span class="token keyword">while</span> expression<span class="token punctuation">.</span>reducible<span class="token operator">?</span>
        puts expression
        step
        <span class="token keyword">end</span>
      puts expression
      <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre></div><p>机器对 #run 的定义仍然没变，但它有了一个新的环境属性，这个属性提供给 #step 方法新的实现使用。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/mblog/assets/js/app.b34711a8.js" defer></script><script src="/mblog/assets/js/2.1254f33f.js" defer></script><script src="/mblog/assets/js/27.7fa9686b.js" defer></script>
  </body>
</html>
